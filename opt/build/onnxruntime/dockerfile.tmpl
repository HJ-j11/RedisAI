#----------------------------------------------------------------------------------------------
{% if REDIS_ARCH == 'x64' %}
{% if REDIS_GPU is defined %}
FROM nvidia/cuda:11.0-cudnn8-devel-ubuntu18.04
{% else %}
FROM ubuntu:bionic
{% endif %}

{% elif REDIS_ARCH == 'jetson' %}
FROM nvcr.io/nvidia/deepstream-l4t:5.1-21.02-base
{% endif %}

{% include 'apt.yml' %}

{% include 'cmake.yml' %}

# build
WORKDIR /build
{% if REDIS_GPU is defined %}
{% set BUILDTYPE = "MinSizeRel" %}
{% set BUILDARGS = "--use_cuda --cudnn_home /usr/local/cuda --cuda_home /usr/local/cuda" %}
{% else %}
{% set BUILDTYPE = "Release" %}
{% set BUILDARGS = "" %} 
{% endif %}

ARG BUILDARGS="--config {{BUILDTYPE}} --parallel"
RUN git clone --single-branch --branch {{REDIS_ONNX_VERSION}} {{REDIS_ONNX_REPO}} onnxruntime
WORKDIR /build/onnxruntime
RUN git fetch --recurse-submodules -j4
RUN ./build.sh --config {{BUILDTYPE}} {{BUILDARGS}} --update --build --build_shared_lib --parallel

# package
ADD ./pack.sh /build
WORKDIR /build
RUN ./pack.sh {{REDIS_BACKEND_VERSION}} {{REDIS_ARCH}} {{BUILDTYPE}} Linux {% if REDIS_GPU is defined %} gpu {% endif %}

#----------------------------------------------------------------------------------------------
{% if REDIS_ARCH == 'x64' %}
FROM ubuntu:bionic
{% elif REDIS_ARCH == 'jetson' %}
FROM nvcr.io/nvidia/deepstream-l4t:5.1-21.02-base
{% endif %}

ARG ONNXRUNTIME_REPO={{REDIS_ONNX_REPO}}
ARG ONNXRUNTIME_VER={{REDIS_ONNX_VERSION}}

RUN apt-get -qq update
RUN DEBIAN_NONINTERACTIVE=1 apt-get install -y curl wget tar git patch  \
	build-essential libcurl4-openssl-dev libssl-dev libatlas-base-dev zlib1g-dev \
    python3.6 python3-pip python3-dev python3-numpy

RUN rm /usr/bin/python3
RUN ln -s /usr/bin/python3.6 /usr/bin/python3
RUN python3 -m pip install --upgrade pip setuptools wheel

ENV LANG=en_US.UTF-8
RUN apt-get install -y locales && \
    sed -i -e "s/# $LANG.*/$LANG UTF-8/" /etc/locale.gen && \
    dpkg-reconfigure --frontend=noninteractive locales && \
    update-locale LANG=$LANG

{% set cmake_version = "3.19.7" %}
RUN wget -q https://github.com/Kitware/CMake/releases/download/v{{cmake_version}}/cmake-{{cmake_version}}-Linux-{{REDIS_CMAKE_ARCH}}.tar.gz -O /tmp/cmake.tgz

WORKDIR /tmp
RUN tar -zxpf /tmp/cmake.tgz
RUN mv /tmp/cmake*/bin/* /usr/bin
RUN mv /tmp/cmake-*/share/cmake* /usr/share/

# build
WORKDIR /build
ARG BUILDTYPE=Release
ARG BUILDARGS="--config ${BUILDTYPE} --parallel"
RUN git clone --single-branch --branch v${ONNXRUNTIME_VER} ${ONNXRUNTIME_REPO} onnxruntime
WORKDIR /build/onnxruntime
RUN git fetch --recurse-submodules
RUN ./build.sh ${BUILDARGS} --update --build
RUN ./build.sh ${BUILDARGS} --build_shared_lib

# package
ADD ./pack.sh /build
WORKDIR /build
RUN ./pack.sh {{REDIS_ONNX_VERSION}} {{REDIS_ARCH}}
